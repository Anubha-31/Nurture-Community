pipeline{
    agent any
    environment {
        DOCKER_TAG = """${sh(script: 'git rev-parse --short HEAD',returnStdout: true)}"""
        BITBUCKET_COMMON_CREDS = credentials('docker')
    }

    stages{
        stage('SCM'){
            steps{
                git branch: 'arshdeepk61-Initial-Version', 
                credentialsId: 'githubMaven', 
                url: 'https://github.com/Anubha-31/Nurture-Community'
            }
        }
        stage('Maven Build'){
            steps{
                sh "mvn -f ./nurturecommunity/pom.xml clean package"
            }
        }
        stage('Docker Build'){
            steps{
                sh "docker build ./nurturecommunity/ -t cranifax/testapp:${DOCKER_TAG}"
            }
        }
        stage('Docker push'){
            steps{
                sh "docker login -u ${BITBUCKET_COMMON_CREDS_USR} -p ${BITBUCKET_COMMON_CREDS_PSW}" 
                sh "docker push cranifax/testapp:${DOCKER_TAG}"
            }
        }
        stage('Docker deploy'){
            steps{
                ansiblePlaybook credentialsId: 'test-server', 
                disableHostKeyChecking: true, 
                extras: "-e DOCKER_TAG=${DOCKER_TAG}", 
                installation: 'ansible', 
                inventory: 'nurturecommunity/test.ini', 
                playbook: 'nurturecommunity/deploy-docker.yml'
            }
        }
        
        
    }
}